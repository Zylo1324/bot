<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iniciar sesi√≥n ‚Ä¢ Zyl0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"
      }
    }
  </script>
  <style>
    :root{
      color-scheme:light;
      --bg:#f8fafc; --ink:#0f172a; --ink-soft:#1e293b; --muted:#475569;
      --field:#ffffff; --field-focus:#f1f5f9; --border:rgba(148,163,184,.35);
      --btn:#f28a2d; --btn-ink:#1c130a; --ghost:rgba(226,232,240,.82); --ghost-border:rgba(148,163,184,.5);
      --ghost-hover-bg:rgba(148,163,184,.28); --ghost-hover-border:rgba(100,116,139,.5);
      --ghost-active-bg:rgba(148,163,184,.36); --ghost-active-border:rgba(71,85,105,.55);
      --success:#16f2a6; --danger:#f97373; --focus:rgba(37,99,235,.45);
      --panel-shadow:0 20px 38px -24px rgba(15,23,42,.28);
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    }
    *{box-sizing:border-box;font-family:inherit;}
    body{
      margin:0;
      min-height:100vh;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:48px 16px;
      position:relative;
      background:
        radial-gradient(circle at 20% 20%,rgba(191,219,254,.35),rgba(191,219,254,0) 52%),
        radial-gradient(circle at 78% 18%,rgba(148,163,184,.24),rgba(148,163,184,0) 58%),
        linear-gradient(180deg,#f8fafc 0%,#e2e8f0 100%);
    }
    .login-shell{
      width:min(520px,100%);
      display:grid;
    }
    .landing-panel{
      background:rgba(255,255,255,.92);
      border-radius:20px;
      border:1px solid var(--border);
      padding:32px;
      box-shadow:var(--panel-shadow);
      display:grid;
      gap:20px;
    }
    .landing-panel header h2{
      margin:0;
      font-size:28px;
      font-weight:700;
    }
    .landing-panel header p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.5;
    }
    .landing-form{
      display:grid;
      gap:18px;
    }
    .landing-form .row{display:grid;gap:8px;text-align:left;}
    label{font-weight:600;}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--ink);
      font-size:15px;
      transition:border-color .2s ease,box-shadow .2s ease,background-color .2s ease;
    }
    input:focus{
      outline:2px solid transparent;
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(37,99,235,.18);
      background:var(--field-focus);
    }
    .pin-wrap{position:relative;display:flex;align-items:center;}
    .pin-wrap input{padding-right:42px;}
    .eye{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:var(--ghost);
      border:1px solid var(--ghost-border);
      border-radius:10px;
      padding:4px 8px;
      cursor:pointer;
      font-size:16px;
      transition:background-color .2s ease,border-color .2s ease;
    }
    .eye:hover{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border);}
    .landing-errors{
      min-height:18px;
      font-size:13px;
      color:var(--danger);
    }
    .landing-errors:empty{display:none;}
    .actions{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{
      border:0;
      border-radius:14px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:600;
      transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease;
      color:var(--ink);
      background:var(--ghost);
      border:1px solid var(--ghost-border);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
    }
    .btn.primary{background:var(--btn);color:var(--btn-ink);box-shadow:0 8px 18px rgba(242,138,45,.28);}
    .btn:hover,.btn:focus-visible{box-shadow:0 10px 20px rgba(15,23,42,.22);transform:translateY(-1px);}
    .btn:active{transform:translateY(0);box-shadow:0 6px 14px rgba(15,23,42,.16);}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;}
    .linklike{
      background:none;
      border:0;
      color:var(--ink-soft);
      cursor:pointer;
      padding:0;
      text-align:left;
      font-size:14px;
      text-decoration:underline;
      align-self:flex-start;
    }
    .landing-google{display:grid;gap:8px;}
    .landing-google .small{margin:0;font-size:13px;color:var(--ink-soft);}    
    .status-message{margin:0;color:var(--danger);font-size:14px;}
    .status-message[hidden]{display:none;}
    @media(max-width:520px){
      body{padding:36px 14px;}
      .landing-panel{padding:28px;}
    }
  </style>
</head>
<body>
  <main class="login-shell">
    <article class="landing-panel" aria-labelledby="loginTitle">
      <header>
        <h2 id="loginTitle">Inicia sesi√≥n</h2>
        <p>Usa tu correo y contrase√±a registrados para entrar al dashboard.</p>
      </header>
      <p id="hostWarning" class="status-message" hidden>Abre esta ventana desde la aplicaci√≥n principal para iniciar sesi√≥n.</p>
      <form id="loginForm" class="landing-form" autocomplete="on">
        <div class="row">
          <label for="authEmail">Correo</label>
          <input id="authEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" required />
        </div>
        <div class="row">
          <label for="authPass">Contrase√±a</label>
          <div class="pin-wrap">
            <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required />
            <button type="button" class="eye" id="toggleAuthPass" aria-label="Mostrar u ocultar contrase√±a">üëÅ</button>
          </div>
        </div>
        <div class="landing-errors" id="authError" role="alert"></div>
        <div class="actions">
          <button type="submit" class="btn primary" id="btnAuthSubmit">Entrar</button>
          <button type="button" class="btn ghost" id="btnClose">Cancelar</button>
        </div>
        <button id="btnForgot" class="linklike" type="button">¬øOlvidaste tu contrase√±a?</button>
        <div class="landing-google">
          <div id="googleButton"></div>
          <p class="small" data-google-feedback></p>
        </div>
      </form>
    </article>
  </main>

  <script type="module">
    import { auth } from './firebaseConfig.js';
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  sendPasswordResetEmail,
  signOut                  // <-- y esta
} from 'firebase/auth';

    const loginForm=document.getElementById('loginForm');
    const authEmailEl=document.getElementById('authEmail');
    const authPassEl=document.getElementById('authPass');
    const authErrorEl=document.getElementById('authError');
    const btnAuthSubmit=document.getElementById('btnAuthSubmit');
    const toggleAuthPass=document.getElementById('toggleAuthPass');
    const btnForgot=document.getElementById('btnForgot');
    const btnClose=document.getElementById('btnClose');
    const googleFeedbackEl=document.querySelector('[data-google-feedback]');
    const googleButton=document.getElementById('googleButton');
    const hostWarning=document.getElementById('hostWarning');

    hostWarning.hidden=true;

    function setError(message='', tone='danger'){
      authErrorEl.textContent=message;
      authErrorEl.style.color = tone==='success' ? 'var(--success)' : tone==='info' ? 'var(--muted)' : 'var(--danger)';
    }

    toggleAuthPass?.addEventListener('click',()=>{
      const isPass=authPassEl.type==='password';
      authPassEl.type=isPass?'text':'password';
      toggleAuthPass.textContent=isPass?'üôà':'üëÅ';
    });

    btnClose?.addEventListener('click',()=>{
      if(window.opener){ window.close(); }
      else{ window.location.href='index.html'; }
    });

    loginForm?.addEventListener('submit',async event=>{
      event.preventDefault();
      const email=(authEmailEl.value||'').trim();
      const pass=(authPassEl.value||'').trim();
      setError('');
      if(!email||!pass){
        setError('Completa correo y contrase√±a.');
        return;
      }
      const originalText=btnAuthSubmit.textContent;
      btnAuthSubmit.disabled=true;
      btnAuthSubmit.textContent='Procesando‚Ä¶';
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await cred.user.reload();
        if (!cred.user.emailVerified) {
          setError('Debes verificar tu correo antes de iniciar sesi√≥n');
          await signOut(auth);   // Cierra sesi√≥n hasta que confirme
          btnAuthSubmit.disabled=false;
          btnAuthSubmit.textContent=originalText;
          return;
        }
        setError('Sesi√≥n iniciada. Puedes cerrar esta ventana.', 'success');
        setTimeout(() => window.close(), 1200);
      } catch (error) {
        console.error(error);
        setError(error?.message || 'No se pudo acceder.');
      } finally {
        btnAuthSubmit.disabled=false;
        btnAuthSubmit.textContent=originalText;
      }

    });

    btnForgot?.addEventListener('click',async ()=>{
      const email=(authEmailEl.value||'').trim();
      setError('');
      if(!email){
        setError('Escribe tu correo arriba para enviarte el enlace.');
        return;
      }
      try{
        await sendPasswordResetEmail(auth,email);
        setError('Te enviamos un correo para restablecer tu contrase√±a.', 'success');
      }catch(error){
        console.error(error);
        setError(error?.message||'No se pudo enviar el correo de recuperaci√≥n.');
      }
    });

    const googleProvider=new GoogleAuthProvider();
    if(googleButton){
      const btn=document.createElement('button');
      btn.type='button';
      btn.className='btn ghost';
      btn.textContent='Continuar con Google';
      btn.addEventListener('click',async()=>{
        btn.disabled=true;
        setError('', 'danger');
        if(googleFeedbackEl){ googleFeedbackEl.textContent='Abriendo Google‚Ä¶'; }
        try{
          await signInWithPopup(auth,googleProvider);
          if(googleFeedbackEl){ googleFeedbackEl.textContent='Sesi√≥n iniciada. Puedes cerrar esta ventana.'; }
          setTimeout(()=>window.close(), 1200);
        }catch(error){
          console.error(error);
          if(googleFeedbackEl){ googleFeedbackEl.textContent=error?.message||'No se pudo iniciar sesi√≥n con Google.'; }
        }finally{
          btn.disabled=false;
        }
      });
      googleButton.innerHTML='';
      googleButton.appendChild(btn);
    }
  </script>
</body>
</html>

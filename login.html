<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#f6f7fb" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0b1420" media="(prefers-color-scheme: dark)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="color-scheme" content="light dark" />
  <title>Iniciar sesión • Zyl0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"
      }
    }
  </script>
  <style>
    :root{
      color-scheme:light;
      --bg-light:#f6f7fb;
      --bg-dark:#0b1420;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --primary:#f28a2d;
      --accent:#1d4ed8;

      --ink:var(--text);
      --ink-soft:color-mix(in srgb,var(--text) 78%,var(--bg));
      --field:var(--card);
      --field-focus:color-mix(in srgb,var(--card) 88%,var(--bg));
      --border:color-mix(in srgb,var(--muted) 32%,transparent);
      --pill-bg:color-mix(in srgb,var(--accent) 14%,transparent);
      --pill-ink:var(--accent);
      --btn:var(--primary);
      --btn-ink:#1c130a;
      --primary-hover:color-mix(in srgb,var(--primary) 92%,var(--card));
      --primary-active:color-mix(in srgb,var(--primary) 88%,var(--muted));
      --ghost:color-mix(in srgb,var(--card) 86%,var(--bg));
      --ghost-border:color-mix(in srgb,var(--muted) 38%,transparent);
      --ghost-hover-bg:color-mix(in srgb,var(--ghost) 80%,var(--accent) 20%);
      --ghost-active-bg:color-mix(in srgb,var(--ghost) 68%,var(--accent) 32%);
      --ghost-hover-border:color-mix(in srgb,var(--accent) 38%,transparent);
      --ghost-active-border:color-mix(in srgb,var(--accent) 48%,transparent);
      --ok:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --link:#2563eb;
      --link-hover:color-mix(in srgb,var(--accent) 35%,var(--bg));
      --link-active:color-mix(in srgb,var(--accent) 55%,var(--bg));
      --success:#16f2a6;
      --danger:#f97373;
      --shadow:0 4px 12px color-mix(in srgb,var(--text) 12%,transparent);
      --shadow-strong:0 12px 28px color-mix(in srgb,var(--text) 18%,transparent);
      --shadow-float:0 10px 20px color-mix(in srgb,var(--text) 22%,transparent);
      --primary-shadow:0 8px 18px color-mix(in srgb,var(--primary) 28%,transparent);
      --panel-shadow-lg:0 20px 38px -24px color-mix(in srgb,var(--text) 24%,transparent);
      --toolbar-bg:color-mix(in srgb,var(--card) 92%,transparent);
      --input-bg:var(--card);
      --input-border:color-mix(in srgb,var(--muted) 42%,transparent);
      --input-focus-border:color-mix(in srgb,var(--accent) 48%,transparent);
      --input-focus-shadow:color-mix(in srgb,var(--accent) 18%,transparent);
      --input-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--muted) 16%,transparent);
      --ghost-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--card) 60%,transparent);
      --surface-inner-shadow:inset 0 1px 0 color-mix(in srgb,var(--muted) 12%,transparent);
      --card-bg:var(--card);
      --table-card-bg:var(--card);
      --table-border:color-mix(in srgb,var(--muted) 24%,transparent);
      --table-row-alt-bg:color-mix(in srgb,var(--bg) 74%,var(--accent) 26%);
      --table-row-hover-bg:color-mix(in srgb,var(--accent) 16%,transparent);
      --table-row-hover-shadow:inset 0 0 0 999px color-mix(in srgb,var(--text) 8%,transparent);
      --menu-bg:var(--card);
      --menu-hover-bg:color-mix(in srgb,var(--bg) 86%,var(--accent) 14%);
      --modal-bg:var(--card);
      --backdrop-bg:color-mix(in srgb,var(--text) 35%,transparent);
      --chat-log-bg:var(--bg);
      --ai-bubble-bg:color-mix(in srgb,var(--card) 88%,var(--bg));
      --ai-bubble-border:color-mix(in srgb,var(--muted) 32%,transparent);
      --eye-bg:color-mix(in srgb,var(--card) 82%,var(--bg));
      --eye-border:color-mix(in srgb,var(--muted) 52%,transparent);
      --addserv-bg:color-mix(in srgb,var(--accent) 28%,var(--bg));
      --addserv-border:color-mix(in srgb,var(--accent) 45%,transparent);
      --addserv-hover-bg:color-mix(in srgb,var(--accent) 32%,var(--bg));
      --addserv-hover-border:color-mix(in srgb,var(--accent) 55%,transparent);
      --addserv-active-bg:color-mix(in srgb,var(--accent) 38%,var(--bg));
      --addserv-active-border:color-mix(in srgb,var(--accent) 65%,transparent);
      --addserv-ink:var(--accent);
      --tag-border:color-mix(in srgb,var(--muted) 36%,transparent);
      --tag-bg:color-mix(in srgb,var(--bg) 82%,var(--muted) 18%);
      --tag-ok-bg:color-mix(in srgb,var(--ok) 18%,transparent);
      --tag-ok-border:color-mix(in srgb,var(--ok) 38%,transparent);
      --tag-warn-bg:color-mix(in srgb,var(--warn) 18%,transparent);
      --tag-warn-border:color-mix(in srgb,var(--warn) 38%,transparent);
      --tag-bad-bg:color-mix(in srgb,var(--bad) 18%,transparent);
      --tag-bad-border:color-mix(in srgb,var(--bad) 40%,transparent);
      --danger-soft-ink:color-mix(in srgb,var(--bad) 26%,var(--card));
      --logo-highlight:color-mix(in srgb,var(--primary) 55%,var(--warn) 45%);
      --launcher-grad:linear-gradient(150deg,var(--card) 0%,color-mix(in srgb,var(--card) 82%,var(--accent) 18%) 100%);
      --sidebar-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 80%,var(--bg)) 100%);
      --panel-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 78%,var(--bg)) 100%);
      --chat-grad:linear-gradient(180deg,var(--bg) 0%,color-mix(in srgb,var(--bg) 86%,var(--muted)) 100%);
      --tag-grad:linear-gradient(135deg,color-mix(in srgb,var(--bg) 92%,var(--muted) 8%) 0%,color-mix(in srgb,var(--bg) 82%,var(--muted) 18%) 100%);
      --table-hover-shadow:inset 0 0 0 999px color-mix(in srgb,var(--accent) 12%,transparent);
      --launcher-focus-outline:color-mix(in srgb,var(--accent) 35%,transparent);
      --action-focus-outline:color-mix(in srgb,var(--accent) 45%,transparent);
      --danger-ghost-bg:color-mix(in srgb,var(--bad) 18%,transparent);
      --danger-ghost-border:color-mix(in srgb,var(--bad) 45%,transparent);
      --danger-ghost-active:color-mix(in srgb,var(--bad) 32%,transparent);
      --menu-danger-bg:color-mix(in srgb,var(--bad) 12%,transparent);
      --menu-danger-border:color-mix(in srgb,var(--bad) 35%,transparent);
      --modal-grad:linear-gradient(180deg,var(--card) 0%,color-mix(in srgb,var(--card) 74%,var(--bg)) 100%);
      --user-bubble-grad:linear-gradient(135deg,var(--primary) 0%,color-mix(in srgb,var(--primary) 80%,var(--warn)) 100%);
      --user-bubble-shadow:0 8px 18px color-mix(in srgb,var(--primary) 28%,transparent);
      --ai-bubble-shadow:0 8px 18px color-mix(in srgb,var(--text) 18%,transparent);
      --radial-accent:color-mix(in srgb,var(--accent) 24%,transparent);
      --radial-success:color-mix(in srgb,var(--success) 18%,transparent);
      --radial-primary:color-mix(in srgb,var(--primary) 18%,transparent);
      --scrollbar-thumb:color-mix(in srgb,var(--accent) 65%,transparent);
      --scrollbar-track:transparent;
      font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    }

    @media(prefers-color-scheme:dark){
      :root{
        color-scheme:dark;
        --bg-light:#f6f7fb;
        --bg-dark:#0b1420;
        --bg:#020617;
        --card:#111827;
        --text:#e2e8f0;
        --muted:#94a3b8;
        --primary:#f59e0b;
        --accent:#60a5fa;
        --btn-ink:#1a1205;
        --ok:#34d399;
        --warn:#fbbf24;
        --bad:#fb7185;
        --link:#93c5fd;
        --success:#16f2a6;
        --danger:#fb7185;
        --logo-highlight:color-mix(in srgb,var(--primary) 45%,var(--warn) 55%);
      }
    }

    html[data-theme="light"]{
      color-scheme:light;
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --primary:#f28a2d;
      --accent:#1d4ed8;
      --btn-ink:#1c130a;
      --ok:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --link:#2563eb;
      --success:#16f2a6;
      --danger:#f97373;
      --logo-highlight:color-mix(in srgb,var(--primary) 55%,var(--warn) 45%);
    }

    html[data-theme="dark"]{
      color-scheme:dark;
      --bg:#020617;
      --card:#111827;
      --text:#e2e8f0;
      --muted:#94a3b8;
      --primary:#f59e0b;
      --accent:#60a5fa;
      --btn-ink:#1a1205;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --link:#93c5fd;
      --success:#16f2a6;
      --danger:#fb7185;
      --logo-highlight:color-mix(in srgb,var(--primary) 45%,var(--warn) 55%);
    }
    *{box-sizing:border-box;font-family:inherit;}
    html,body{background-color:var(--bg-light);}
    @media(prefers-color-scheme:dark){html,body{background-color:var(--bg-dark);}}
    body{
      margin:0;
      min-height:100vh;
      color:var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:48px 16px;
      position:relative;
      background-color:var(--bg-light);
      background:
        radial-gradient(circle at 20% 20%,color-mix(in srgb,var(--accent) 28%,transparent),transparent 52%),
        radial-gradient(circle at 78% 18%,color-mix(in srgb,var(--muted) 24%,transparent),transparent 58%),
        linear-gradient(180deg,var(--bg) 0%,color-mix(in srgb,var(--bg) 70%,var(--muted)) 100%);
    }
    .login-shell{
      width:min(520px,100%);
      display:grid;
    }
    .landing-panel{
      background:var(--toolbar-bg);
      border-radius:20px;
      border:1px solid var(--border);
      padding:32px;
      box-shadow:var(--panel-shadow-lg);
      display:grid;
      gap:20px;
    }
    .landing-panel header h2{
      margin:0;
      font-size:28px;
      font-weight:700;
    }
    .landing-panel header p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.5;
    }
    .landing-form{
      display:grid;
      gap:18px;
    }
    .landing-form .row{display:grid;gap:8px;text-align:left;}
    label{font-weight:600;}
    input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--field);
      color:var(--ink);
      font-size:15px;
      transition:border-color .2s ease,box-shadow .2s ease,background-color .2s ease;
    }
    input:focus{
      outline:2px solid transparent;
      border-color:var(--input-focus-border);
      box-shadow:0 0 0 4px var(--input-focus-shadow);
      background:var(--field-focus);
    }
    .pin-wrap{position:relative;display:flex;align-items:center;}
    .pin-wrap input{padding-right:42px;}
    .eye{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:var(--ghost);
      border:1px solid var(--ghost-border);
      border-radius:10px;
      padding:4px 8px;
      cursor:pointer;
      font-size:16px;
      transition:background-color .2s ease,border-color .2s ease;
    }
    .eye:hover{background:var(--ghost-hover-bg);border-color:var(--ghost-hover-border);}
    .landing-errors{
      min-height:18px;
      font-size:13px;
      color:var(--danger);
    }
    .landing-errors:empty{display:none;}
    .actions{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{
      border:0;
      border-radius:14px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:600;
      transition:background-color .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease;
      color:var(--ink);
      background:var(--ghost);
      border:1px solid var(--ghost-border);
      box-shadow:var(--ghost-inner-shadow);
    }
    .btn.primary{background:var(--btn);color:var(--btn-ink);box-shadow:var(--primary-shadow);}
    .btn:hover,.btn:focus-visible{box-shadow:var(--shadow-float);transform:translateY(-1px);}
    .btn:active{transform:translateY(0);box-shadow:var(--shadow);}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none;}
    .linklike{
      background:none;
      border:0;
      color:var(--link);
      cursor:pointer;
      padding:0;
      text-align:left;
      font-size:14px;
      text-decoration:underline;
      align-self:flex-start;
      transition:color .2s ease;
    }
    .linklike:hover,.linklike:focus-visible{color:var(--link-hover);}
    .linklike:active{color:var(--link-active);}
    .landing-google{display:grid;gap:8px;}
    .landing-google .small{margin:0;font-size:13px;color:var(--ink-soft);}    
    .status-message{margin:0;color:var(--danger);font-size:14px;}
    .status-message[hidden]{display:none;}
    @media(max-width:520px){
      body{padding:36px 14px;}
      .landing-panel{padding:28px;}
    }
  </style>
</head>
<body>
  <main class="login-shell">
    <article class="landing-panel" aria-labelledby="loginTitle">
      <header>
        <h2 id="loginTitle">Inicia sesión</h2>
        <p>Usa tu correo y contraseña registrados para entrar al dashboard.</p>
      </header>
      <p id="hostWarning" class="status-message" hidden>Abre esta ventana desde la aplicación principal para iniciar sesión.</p>
      <form id="loginForm" class="landing-form" autocomplete="on">
        <div class="row">
          <label for="authEmail">Correo</label>
          <input id="authEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email" required />
        </div>
        <div class="row">
          <label for="authPass">Contraseña</label>
          <div class="pin-wrap">
            <input id="authPass" type="password" placeholder="••••••••" autocomplete="current-password" required />
            <button type="button" class="eye" id="toggleAuthPass" aria-label="Mostrar u ocultar contraseña">👁</button>
          </div>
        </div>
        <div class="landing-errors" id="authError" role="alert"></div>
        <div class="actions">
          <button type="submit" class="btn primary" id="btnAuthSubmit">Entrar</button>
          <button type="button" class="btn ghost" id="btnClose">Cancelar</button>
        </div>
        <button id="btnForgot" class="linklike" type="button">¿Olvidaste tu contraseña?</button>
        <div class="landing-google">
          <div id="googleButton"></div>
          <p class="small" data-google-feedback></p>
        </div>
      </form>
    </article>
  </main>

  <script type="module">
    import { auth } from './firebaseConfig.js';
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  sendPasswordResetEmail,
  signOut                  // <-- y esta
} from 'firebase/auth';

    const loginForm=document.getElementById('loginForm');
    const authEmailEl=document.getElementById('authEmail');
    const authPassEl=document.getElementById('authPass');
    const authErrorEl=document.getElementById('authError');
    const btnAuthSubmit=document.getElementById('btnAuthSubmit');
    const toggleAuthPass=document.getElementById('toggleAuthPass');
    const btnForgot=document.getElementById('btnForgot');
    const btnClose=document.getElementById('btnClose');
    const googleFeedbackEl=document.querySelector('[data-google-feedback]');
    const googleButton=document.getElementById('googleButton');
    const hostWarning=document.getElementById('hostWarning');

    hostWarning.hidden=true;

    function setError(message='', tone='danger'){
      authErrorEl.textContent=message;
      authErrorEl.style.color = tone==='success' ? 'var(--success)' : tone==='info' ? 'var(--muted)' : 'var(--danger)';
    }

    toggleAuthPass?.addEventListener('click',()=>{
      const isPass=authPassEl.type==='password';
      authPassEl.type=isPass?'text':'password';
      toggleAuthPass.textContent=isPass?'🙈':'👁';
    });

    btnClose?.addEventListener('click',()=>{
      if(window.opener){ window.close(); }
      else{ window.location.href='index.html'; }
    });

    loginForm?.addEventListener('submit',async event=>{
      event.preventDefault();
      const email=(authEmailEl.value||'').trim();
      const pass=(authPassEl.value||'').trim();
      setError('');
      if(!email||!pass){
        setError('Completa correo y contraseña.');
        return;
      }
      const originalText=btnAuthSubmit.textContent;
      btnAuthSubmit.disabled=true;
      btnAuthSubmit.textContent='Procesando…';
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await cred.user.reload();
        if (!cred.user.emailVerified) {
          setError('Debes verificar tu correo antes de iniciar sesión');
          await signOut(auth);   // Cierra sesión hasta que confirme
          btnAuthSubmit.disabled=false;
          btnAuthSubmit.textContent=originalText;
          return;
        }
        setError('Sesión iniciada. Puedes cerrar esta ventana.', 'success');
        setTimeout(() => window.close(), 1200);
      } catch (error) {
        console.error(error);
        setError(error?.message || 'No se pudo acceder.');
      } finally {
        btnAuthSubmit.disabled=false;
        btnAuthSubmit.textContent=originalText;
      }

    });

    btnForgot?.addEventListener('click',async ()=>{
      const email=(authEmailEl.value||'').trim();
      setError('');
      if(!email){
        setError('Escribe tu correo arriba para enviarte el enlace.');
        return;
      }
      try{
        await sendPasswordResetEmail(auth,email);
        setError('Te enviamos un correo para restablecer tu contraseña.', 'success');
      }catch(error){
        console.error(error);
        setError(error?.message||'No se pudo enviar el correo de recuperación.');
      }
    });

    const googleProvider=new GoogleAuthProvider();
    if(googleButton){
      const btn=document.createElement('button');
      btn.type='button';
      btn.className='btn ghost';
      btn.textContent='Continuar con Google';
      btn.addEventListener('click',async()=>{
        btn.disabled=true;
        setError('', 'danger');
        if(googleFeedbackEl){ googleFeedbackEl.textContent='Abriendo Google…'; }
        try{
          await signInWithPopup(auth,googleProvider);
          if(googleFeedbackEl){ googleFeedbackEl.textContent='Sesión iniciada. Puedes cerrar esta ventana.'; }
          setTimeout(()=>window.close(), 1200);
        }catch(error){
          console.error(error);
          if(googleFeedbackEl){ googleFeedbackEl.textContent=error?.message||'No se pudo iniciar sesión con Google.'; }
        }finally{
          btn.disabled=false;
        }
      });
      googleButton.innerHTML='';
      googleButton.appendChild(btn);
    }
  </script>
</body>
</html>
